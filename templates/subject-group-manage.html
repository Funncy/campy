{% load static %}
{% include "include/header.html" %}
  
<div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>
            과목 그룹 관리
            <small>Subject Group Management</small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> 과목 그룹 관리</a></li>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content container-fluid">
                <div class="box box-primary">
                    <div class="overlay" id="search-check" style="display: none;">
                            <i class="fa fa-check"></i>
                    </div>
                        <div class="box-header with-border">
                            <h4>STEP 1: 과목 그룹 검색</h4>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse" id="search-rule">
                                  <i class="fa fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>대학교</label>
                                        <select class="form-control" id="university_list">
                                            {% for university in universitys %}
                                                <option value="{{ university.meta_data_relation_code }}">{{ university.meta_data_relation_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">

                                <div class="col-md-12">
                                    <button class="btn btn-primary" style="width: 100%" id="rule_search">과목 그룹 조회하기</button>
                                </div>
                            </div>
                        </div>
                        <div class="box-footer clearfix">
                            <div class="col-md-12">
                                <span><i class="fa fa-warning"></i>과목 그룹이 검색되지 않으면 <a href="#"><b>여기</b></a>로 신고 바랍니다.</span>
                            </div>
                        </div>
                </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="box box-primary collapsed-box">
                        <div class="overlay" id="result-wait" style="display: none;">
                            <i class="fa fa-lock"></i>
                        </div>
                        <div class="box-header with-border">
                            <h3 class="box-title">STEP 2: 과목 그룹 확인 및 설정</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse" id="result-rule"><i class="fa fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="box-body" style="display:none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>대학교</label>
                                        <div class="form-control" id="result_university">
                                            대학교 자동입력
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <button type="submit" id="result-close" class="btn btn-primary btn-block">
                                        <i class="fa fa-undo"></i> 과목 그룹 재검색
                                    </button>
                                    <br>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <table class="table table-bordered table-striped table-hover text-center" id="table-rule">
                                        <thead>
                                            <tr>
                                                <th class="hidden-xs" style="width: 80px">과목 그룹 번호</th>
                                                <th>대학</th>
                                                <th>과목 그룹 이름</th>
                                                <th class="hidden-xs" style="width: 100px">관리</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-group">
                                            <tr  data-toggle="modal" data-target="#Mo_plus">
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                <button class="btn btn-danger btn-xs">삭제</button>
                                            </td>
                                        </tr>
                                        <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td>
                                                    <button class="btn btn-primary btn-xs" data-toggle="modal" data-target="#add_subject_group">추가</button>
                                                </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="box-footer" style="display: none;">
                            <i class="icon fa fa-info-circle"></i> 각 과목 그룹에 해당하는 이수 교과목은 <a href="#"><b>과목 그룹 관리</b></a>에서 지정하실 수 있습니다.<br>
                            <i class="icon fa fa-info-circle"></i> 엑셀파일로 모든 학과의 졸업 요건을 내보내고 싶으신가요? <a href="#"><b>서비스 준비 중</b></a>
                        </div>
            </div>


        <div class="modal fade" id="modal-read">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">선택하신 그룹에 지정된 과목 목록입니다.</h4>
                    </div>
                    <div class="modal-body" id ="modal-read-body">
                        <div class="row">
                            <div class="col-md-12">
                                <p class="text-bold">이수구분</p>
                                <table class="table table-bordered table-striped table-hover text-center">
                                    <thead>
                                    <tr>
                                        <th>이수구분</th>
                                        <th class="hidden-xs" style="width: 100px">관리</th>
                                    </tr>
                                    </thead>
                                    <tbody id="divisionList_read">
                                    </tbody>
                                </table>

                                <p class="text-bold">선택 영역</p>
                                <table class="table table-bordered table-striped table-hover text-center">
                                    <thead>
                                    <tr>
                                        <th>선택영역</th>
                                        <th class="hidden-xs" style="width: 100px">관리</th>
                                    </tr>
                                    </thead>
                                    <tbody id="areaList_read">
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.col -->
                        </div>
                        <!-- /.row -->

                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->

        <div class="modal fade" id="modal-new-group">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">새로운 과목 그룹을 생성합니다.</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group form-group-lg">
                                    <label for="systemName">새 과목 그룹 이름</label>
                                    <input type="text" class="form-control text-bold text-center" id="groupName"
                                           placeholder="새로운 과목 그룹의 이름을 입력해주십시오.">
                                </div>
                            </div>
                            <!-- /.col -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-primary" onclick="addGroup()" data-dismiss="modal">생성하기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modal-delete">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">정말로 삭제 하시겠습니까?</h4>
                    </div>
                    <div class="modal-body" id="modal-delete-body">

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group form-group-lg">
                                    <label for="systemName">삭제할 과목 그룹 이름</label>
                                    <input type="text" class="form-control text-bold text-center" id="modal_delete_group_name"
                                    disabled>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <i class="icon fa fa-info-circle"></i> 유의하여 삭제해주시기 바랍니다. <span style="color:#dd4b39;">연결된 졸업요건도 같이 삭제 됩니다.</span>
                            </div>
                            <!-- /.col -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">닫기</button>
                            <button type="button" class="btn btn-primary" id="modal_delete">삭제하기</button>
                        </div>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>

        <div class="modal fade" id="modal-list">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">새로운 과목을 추가합니다.</h4>
                    </div>
                    <div class="modal-body" id="modal-list-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>과목 검색</label>
                                    <input type="text" class="form-control text-bold text-center" id="searchList"
                                           placeholder="검색하고자 하는 과목 이름의 일부를 입력하십시오.">
                                </div>
                                <table class="table table-bordered table-striped table-hover text-center">
                                    <thead>
                                    <tr>
                                        <th class="hidden-xs" style="width: 50px">선택</th>
                                        <th style="width: 80px">학수번호</th>
                                        <th>과목 이름</th>
                                        <th style="width: 120px">영역</th>
                                        <th style="width: 50px">학점</th>
                                    </tr>
                                    </thead>
                                    <tbody id="subject-option-list">
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.col -->
                        </div>
                    </div>
                    <div class="modal-footer" id="searchFooter">
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>

        </section>

      </div>

<script>

    var delete_group_no = 0;

    $('#rule_search').click(function(){
        // 검색 버튼 죽이기
        $('#rule_search').prop('disabled', 'disabled')
        $('#search-check').css('display', '')

        reload(1)
    })

    function reload(open){
        $.ajax({
            url: '/data/graduation/group/',
            type: 'GET',
            data: {
                'university_name': $('#university_list option:selected').text()
            },
            success: function (result) {

                $('#tbody-group').empty()

                for(var key in result){
                 $('#tbody-group').append(
                     "<tr><td>"+result[key].id
                     +"</td><td data-toggle=\"modal\" data-target=\"#modal-read\" onclick=\"readGroup("+result[key].id+")\">"+result[key].subject_group_name
                     +"</td><td>"+result[key].subject_group_university_name
                     +"</td><td><button class=\"btn btn-danger btn-xs\" data-toggle=\"modal\" data-target=\"#modal-delete\" onclick=\""
                     +"delete_group("+result[key].id+",'"+result[key].subject_group_name+"')\">삭제</button></td></tr>"
                 )
                }


                $('#tbody-group').append("<tr><td></td><td></td><td></td><td>"
                    +"<button class=\"btn btn-primary btn-xs\""
                    +" data-toggle=\"modal\" data-target=\"#modal-new-group\" "
                    +">추가</button></td></tr>")

                //추가 모달 셋팅
                get_divison()

                if (open == 1) {
                    // 결과 박스 동기화
                    $('#search-rule').trigger("click");
                    $('#result-wait').css("display", "none");
                    $('#result-rule').trigger("click");
                    $('#result-close').prop('disabled', '')
                }

            },
            error: function(request,status,error) {
                $('#rule_search').prop('disabled', '');
                $('#search-check').css("display", "none");
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    }

    // 그룹 삭제
    function delete_group(pk, group_name){
        delete_group_no = pk;
        $('#modal_delete_group_name').val(group_name)
    }

    $('#modal_delete').click(function(){
        $.ajax({
            url: '/data/graduation/group/'+delete_group_no+'/',
            type: 'DELETE',
            data: {
            },
            success: function (result) {
                $('#modal-delete').prop('disabled', '')
                $('#modal-delete').modal('hide')
                reload(0)
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    })

    // 그룹 추가
    function set_modal_create(){
        $.ajax({
            url: '/data/graduation/group/mapping/',
            type: 'GET',
            data: {
                'subject_group' : 'meta_completionDivision'
            },
            success: function (result) {
               $('#division_table').empty()
                for(var key in result){
                    $('#division_table').append(
                        "<tr><td><input type='checkbox' id='new-"+result[key].id+"' class=\"minimal-red\" name=\"selectedList\""
                        +" value='"+result[key].id+"'></td><td>"
                        +result[key].meta_data_relation_name+"</td></tr>"
                    )
                }
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    }

    // 이수구분 모달 데이터 생성
    function get_divison(){
        $.ajax({
            url: '/data/common/metainfo/',
            type: 'GET',
            data: {
                'meta_data_code' : 'meta_completionDivision',
                'upper_data_code' : $('#university_list').val()
            },
            success: function (result) {
               $('#division_table').empty()
                for(var key in result){
                    $('#division_table').append(
                        "<tr><td><input type='checkbox' id='new-"+result[key].id+"' class=\"minimal-red\" name=\"selectedList\""
                        +" value='"+result[key].id+"'></td><td>"
                        +result[key].meta_data_relation_name+"</td></tr>"
                    )
                }
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    }

    function add_division(){
        var checkboxValues = [];
        $("input[name='selectedList']:checked").each(function (i) {
            checkboxValues.push($(this).val());
        });

        $.ajax({
            url: '/data/grduation/group/',
            type: 'GET',
            data: {
                'meta_data_code' : 'meta_completionDivision',
                'divisions' : checkboxValues
            },
            success: function (result) {

            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })


    }

    $('#result-close').click(function() {
        $('#result-close').prop('disabled', 'disabled')
        $('#search-check').css("display", "none");
        $('#result-rule').trigger("click");
        $('#search-rule').trigger("click");
        $('#result-wait').css("display", "disabled");
        // 검색 버튼 살리기
        $('#rule_search').prop('disabled', '');
    })

    function addGroup(){
        $.ajax({
            url: '/data/graduation/group/',
            type: 'POST',
            data: {
                'subject_group_university_name' : $('#university_list option:selected').text(),
                'subject_group_name' : $('#groupName').val()
            },
            success: function (result) {
                reload(0);
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    }

    function readGroup(group_id){
        $.ajax({
            url: '/data/graduation/group/mapping/',
            type: 'GET',
            data: {
                'mapping_subject_group' : group_id
            },
            success: function (result) {

                $('#divisionList_read').empty()
                $('#areaList_read').empty()

                for(var key in result){
                    if(result[key].mapping_completion_division != ''){
                        $('#divisionList_read').append(
                            "<tr><td>"+result[key].mapping_completion_division+"</td><td class=\"hidden-xs\">"
                            +"<button type=\"button\" class=\"btn btn-danger btn-xs\" onclick=\"removeMapping("
                            +result[key].id+")\" >삭제</button></td></tr>"
                        )
                    }else if(result[key].mapping_area != ''){

                    }
                }
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        })
    }
</script>

{% include "include/footer.html" %}