{% include "include/header.html"%}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            과목 관리
            <small>Subject Settings</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-university"></i> Settings</a></li>
            <li class="active">Subject</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content container-fluid">

        {% include "include/alert.html"%}

        <div class="row">
            <div class="col-md-12">
                <div class="box box-warning">
                    <div class="overlay" id="search-check" style="display: none;">
                        <i class="fa fa-check"></i>
                    </div>
                    <div class="box-header with-border">
                        <h3 class="box-title">STEP 1: 과목 검색</h3>
                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse" id="search-subject"><i class="fa fa-minus"></i></button>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="subject">개설 과목</label>
                                    <select class="form-control select2" id="subject" style="width: 100%;">
                                        <option value="0" selected="selected">과목 선택</option>
                                        <!--#subjects-->
                                        <option value="<!--academicNo-->">[<!--academicNo-->] <!--name--></option>
                                        <!--/subjects-->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="year">과목 그룹 : 입학연도</label>
                                    <select class="form-control select2" id="year" style="width: 100%;">
                                        <option value="0" selected="selected">전체</option>
                                        <option value="2018">2018</option>
                                        <option value="2017">2017</option>
                                        <option value="2016">2016</option>
                                        <option value="2015">2015</option>
                                        <option value="2014">2014</option>
                                        <option value="2013">2013</option>
                                    </select>
                                </div>
                            </div>
                            <!-- /.col -->
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="major">과목 그룹 : 학과</label>
                                    <select class="form-control select2" id="major" style="width: 100%;">
                                        <option value="0" selected="selected">전체</option>
                                    </select>
                                </div>
                                <!-- /.form-group -->
                            </div>
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" id="search" class="btn btn-default btn-block"><i class="fa fa-search"></i> 과목 조회하기
                                </button>
                            </div>
                            <!-- /.col -->
                        </div>
                        <!-- /.row -->
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer clearfix">
                        <i class="icon fa fa-warning"></i> 이 기능은 개별 과목 중심의 시스템 관리를 위해 제공되며, 특정 기능의 수행은 시스템 전체에 중대한 영향을 미칠 수 있으므로 이용에 유의하시기 바랍니다.
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="box box-danger collapsed-box">
                    <div class="overlay" id="result-wait">
                        <i class="fa fa-lock"></i>
                    </div>
                    <div class="box-header with-border">
                        <h3 class="box-title">STEP 2: 과목 확인 및 설정</h3>

                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse" id="result-subject"><i
                                    class="fa fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="box-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>개설 과목</label>
                                    <span class="form-control" id="searched_subject" style="width: 100%;">-</span>
                                </div>
                            </div>
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>과목 그룹 : 입학연도</label>
                                    <span class="form-control" id="searched_year" style="width: 100%;">-</span>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label>과목 그룹 : 학과</label>
                                    <span class="form-control" id="searched_major" style="width: 100%;">-</span>
                                </div>
                            </div>
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" id="result-close" class="btn btn-default btn-block"><i class="fa fa-undo"></i> 과목 재검색</button>
                                <p class="text-center">&mdash;</p>
                            </div>
                            <!-- /.col -->
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-md-12">
                                <table class="table table-bordered table-striped table-hover text-center" id="table-group">
                                    <thead>
                                    <tr>
                                        <th class="hidden-xs" style="width: 80px">그룹 번호</th>
                                        <th>과목 그룹 이름</th>
                                        <th style="width: 80px">이수 구분</th>
                                        <th class="hidden-xs" style="width: 100px">관리</th>
                                    </tr>
                                    </thead>
                                    <tbody id="group_list">
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.col -->
                        </div>
                        <!-- /.row -->
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer" style="display: none;">
                        특수 규칙
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modal-create">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">선택한 과목 그룹에 새로운 과목을 지정합니다.</h4>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label>개설 과목</label>
                                            <span class="form-control" id="modal_searched_subject" style="width: 100%;">-</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.row -->
                                <p class="text-center">&mdash;</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="year">입학연도</label>
                                            <select class="form-control select2" id="modal_year" style="width: 100%;">
                                                <option value="0" selected="selected">모든 입학연도</option>
                                                <option value="2018">2018</option>
                                                <option value="2017">2017</option>
                                                <option value="2016">2016</option>
                                                <option value="2015">2015</option>
                                                <option value="2014">2014</option>
                                                <option value="2013">2013</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- /.col -->
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="modal_major">학과</label>
                                            <select class="form-control select2" multiple="multiple" id="modal_major" style="width: 100%;" data-placeholder="선택해주세요" disabled>
                                                <option value="0" selected="selected">모든 학과</option>
                                            </select>
                                        </div>
                                        <!-- /.form-group -->
                                    </div>
                                </div>
                                <!-- /.row -->
                                <div class="row">
                                    <div class="col-md-9">
                                        <div class="form-group has-feedback">
                                            <label for="modal_subject_group">과목 그룹</label>
                                            <select class="form-control select2" multiple="multiple" id="modal_subject_group" style="width: 100%;" data-placeholder="선택해주세요">
                                                <option value="2">중핵필수(중필)</option>
                                                <option value="3">중핵선택(중선)</option>
                                                <option value="4">전공기초교양(기교)</option>
                                                <option value="5">전공필수(전필)</option>
                                                <option value="6">전공선택(전선)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group has-feedback">
                                            <label for="modal_essential">이수 구분</label>
                                            <select class="form-control select2" id="modal_essential" style="width: 100%;">
                                                <option value="0" selected="selected">선택 이수</option>
                                                <option value="1">필수 이수</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.row -->
                            </form>
                            <i class="icon fa fa-warning"></i> 선택하신 과목이 특정 과목 그룹에 이미 지정되어 있는 경우에는 설정된 값으로 변경됩니다.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">닫기</button>
                            <button type="button" class="btn btn-primary" id="modal_create">지정하기</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->

{% include "include/footer.html"%}

<script type="text/javascript">
    var subject = $('#subject');
    var year = $('#year');
    var major = $('#major');
    var group_list = $('#group_list');

    var modal_year = $('#modal_year');
    var modal_major = $('#modal_major');

    $('.select2').select2();

    $('#modal-create').on('shown.bs.modal', function () {
        $('#modal-read-body').scrollTop(0);
    });

    year.change(function () {
        if(year.find('option:selected').val() === '0') {
            major.empty();
            major.append('<option value="0" selected="selected">전체</option>');

            return;
        }

        major.prop('disabled', 'disabled');

        $.ajax({
            url: '/group/search/department',
            type: 'get',
            data: { 'year' : year.val() },
            success: function (result) {
                if (result['result'] === 'success') {
                    major.empty();

                    if (!result['count']) {
                        major.append('<option value="0" selected="selected">전체</option>');

                        iziToast.show({
                            title: '알림',
                            message: info01 + alert03,
                            theme: 'light',
                            color: 'red',
                            position: 'topRight',
                            timeout: 3000
                        })
                    } else {
                        major.append('<option value="0" selected="selected">전체</option>');

                        for (var key in result['departments']) {
                            if (result['departments'].hasOwnProperty(key)) {
                                major.append('<option value="' + result['departments'][key]['no'] + '">' + result['departments'][key]['name'] + '</option>')
                            }
                        }

                        major.prop('disabled', '')
                    }
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert02,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    })
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                })
            }
        })
    });

    modal_year.change(function () {
        if(modal_year.find('option:selected').val() === '0') {
            modal_major.empty();
            modal_major.append('<option value="0" selected="selected">모든 학과</option>');
            modal_major.prop('disabled', 'disabled');

            return;
        }

        modal_major.prop('disabled', 'disabled');

        $.ajax({
            url: '/group/search/department',
            type: 'get',
            data: { 'year' : modal_year.val() },
            success: function (result) {
                if (result['result'] === 'success') {
                    modal_major.empty();

                    if (!result['count']) {
                        modal_major.append('<option value="0" selected="selected">없음</option>');

                        iziToast.show({
                            title: '알림',
                            message: info01 + alert03,
                            theme: 'light',
                            color: 'red',
                            position: 'topRight',
                            timeout: 3000
                        })
                    } else {
                        modal_major.append('<option value="0">모든 학과</option>');

                        for (var key in result['departments']) {
                            if (result['departments'].hasOwnProperty(key)) {
                                modal_major.append('<option value="' + result['departments'][key]['no'] + '">' + result['departments'][key]['name'] + '</option>')
                            }
                        }

                        modal_major.prop('disabled', '')
                    }
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert02,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    })
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                })
            }
        })
    });

    $('#search').click(function () {
        if(subject.find('option:selected').val() === '0') {
            iziToast.show({
                title: '알림',
                message: info01 + alert05,
                theme: 'light',
                color: 'red',
                position: 'topRight',
                timeout: 3000
            });

            return;
        }

        $('#search').prop('disabled', 'disabled');
        $('#search-check').css("display", '');

        $.ajax({
            url: '/subject/search',
            type: 'get',
            data: { 'subject' : subject.val(),
                'year': year.val(),
                'department': major.val() },
            success: function (result) {
                if (result['result'] === 'success') {
                    $('#searched_subject').text($('#subject').find('option:selected').text());
                    $('#searched_year').text($('#year').find('option:selected').text());
                    $('#searched_major').text($('#major').find('option:selected').text());
                    $('#modal_searched_subject').text($('#subject').find('option:selected').text());
                    $('#group_list').empty();

                    group_list.empty();

                    for (var key in result['groups']) {
                        if (result['groups'].hasOwnProperty(key)) {
                            var essential = "선택";

                            if (result['groups'][key]['systemSubjectGroupSubjectMappings'][0]['essential'] === 1) {
                                essential = "필수";
                            }

                            group_list.append('<tr><td class="hidden-xs">' + result['groups'][key]['no']
                                + '</td><td>' + result['groups'][key]['name'] + '</td>'
                                + '<td>' + essential + '</td><td class="hidden-xs"><button type="button" class="btn btn-warning btn-xs" disabled>대체</button> <button type="button" class="btn btn-danger btn-xs" onclick="remove(' + result['groups'][key]['no'] + ')">해제</button></td></tr>')
                        }
                    }

                    group_list.append('<tr class="hidden-xs"><td></td><td></td><td></td><td><button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#modal-create">새 그룹 지정</button></td></tr>');

                    $('#search-subject').trigger('click');
                    $('#result-wait').css('display', 'none');
                    $('#result-subject').trigger('click')
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert02,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    });

                    $('#searched_subject').text('-');
                    $('#searched_year').text('-');
                    $('#searched_major').text('-');

                    $('#search-check').css('display', 'none');
                    $('#search').prop('disabled', '')
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                });

                $('#searched_subject').text('-');
                $('#searched_year').text('-');
                $('#searched_major').text('-');

                $('#search-check').css('display', 'none');
                $('#search').prop('disabled', '')
            }
        })
    });

    $('#modal_create').click(function() {
        var selected_major_list = [];
        var selected_group_list = [];

        if ($('#modal_major :selected').length > 0){
            $('#modal_major :selected').each(function(i, selected) {
                selected_major_list[i] = $(selected).val();
            });
        } else {
            iziToast.show({
                title: '알림',
                message: info01 + alert05,
                theme: 'light',
                color: 'red',
                position: 'topRight',
                timeout: 3000
            });

            return;
        }

        if ($('#modal_subject_group :selected').length > 0){
            $('#modal_subject_group :selected').each(function(i, selected) {
                selected_group_list[i] = $(selected).val();
            });
        } else {
            iziToast.show({
                title: '알림',
                message: info01 + alert05,
                theme: 'light',
                color: 'red',
                position: 'topRight',
                timeout: 3000
            });

            return;
        }

        $.ajax({
            url: '/subject/command/create',
            type: 'post',
            data: { 'subject' : subject.val(),
                'year' : modal_year.val(),
                'departments' : JSON.stringify(selected_major_list),
                'groups': JSON.stringify(selected_group_list),
                'essential': $('#modal_essential').val() },
            success: function (result) {
                if (result['result'] === 'success') {
                    iziToast.show({
                        title: '알림',
                        message: info00,
                        theme: 'light',
                        color: 'green',
                        position: 'topRight',
                        timeout: 1500,
                        onOpened: function () {
                            reload() }
                    });
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert00,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    });
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                });
            }
        })
    });

    $(document).ready(function () {
        $('#searchList').on('keyup', function () {
            var value = $(this).val().toLowerCase();
            $('#subject-option-list').find('tr').filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        })
    });

    $('#result-close').click(function() {
        $('#search').prop('disabled', '');
        $('#search-check').css('display', 'none');

        $('#search-subject').trigger('click');
        $('#result-wait').css('display', '');
        $('#result-subject').trigger('click')
    });

    function remove(groupNo) {
        $.ajax({
            url: '/subject/command/remove',
            type: 'get',
            data: { 'subject' : subject.val(),
                'group': groupNo },
            success: function (result) {
                if (result['result'] === 'success') {
                    iziToast.show({
                        title: '알림',
                        message: info00,
                        theme: 'light',
                        color: 'green',
                        position: 'topRight',
                        timeout: 1500,
                        onOpened: function () {
                            reload() }
                    });
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert00,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    });

                    $('#searched_subject').text('-');
                    $('#searched_year').text('-');
                    $('#searched_major').text('-');

                    $('#search-check').css('display', 'none');
                    $('#search').prop('disabled', '')
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                });

                $('#searched_subject').text('-');
                $('#searched_year').text('-');
                $('#searched_major').text('-');

                $('#search-check').css('display', 'none');
                $('#search').prop('disabled', '')
            }
        })
    }

    function reload() {
        $.ajax({
            url: '/subject/search',
            type: 'get',
            data: { 'subject' : subject.val(),
                'year': year.val(),
                'department': major.val() },
            success: function (result) {
                if (result['result'] === 'success') {
                    $('#searched_subject').text($('#subject').find('option:selected').text());
                    $('#searched_year').text($('#year').find('option:selected').text());
                    $('#searched_major').text($('#major').find('option:selected').text());
                    $('#modal_searched_subject').text($('#subject').find('option:selected').text());
                    $('#group_list').empty();

                    group_list.empty();

                    for (var key in result['groups']) {
                        if (result['groups'].hasOwnProperty(key)) {
                            var essential = "선택";

                            if (result['groups'][key]['systemSubjectGroupSubjectMappings'][0]['essential'] === 1) {
                                essential = "필수";
                            }

                            group_list.append('<tr><td class="hidden-xs">' + result['groups'][key]['no']
                                + '</td><td>' + result['groups'][key]['name'] + '</td>'
                                + '<td>' + essential + '</td><td class="hidden-xs"><button type="button" class="btn btn-warning btn-xs" disabled>대체</button> <button type="button" class="btn btn-danger btn-xs" onclick="remove(' + result['groups'][key]['no'] + ')">해제</button></td></tr>')
                        }
                    }

                    group_list.append('<tr class="hidden-xs"><td></td><td></td><td></td><td><button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#modal-create">새 그룹 지정</button></td></tr>');
                } else {
                    iziToast.show({
                        title: '알림',
                        message: info01 + alert02,
                        theme: 'light',
                        color: 'red',
                        position: 'topRight',
                        timeout: 3000
                    });

                    $('#searched_subject').text('-');
                    $('#searched_year').text('-');
                    $('#searched_major').text('-');
                }
            },
            error: function () {
                iziToast.show({
                    title: '알림',
                    message: info01 + alert00,
                    theme: 'light',
                    color: 'red',
                    position: 'topRight',
                    timeout: 3000
                });

                $('#searched_subject').text('-');
                $('#searched_year').text('-');
                $('#searched_major').text('-');
            }
        })
    }

</script>

{% include "include/script.html"%}